<html lang="en" xmlns:th="http://www.thymeleaf.org">
<div th:fragment="script">
	<script>
		function updateCartCount() {
			fetch('/customer/cart/count')
				.then(response => response.json())
				.then(data => {
					document.querySelector('.badge.bg-danger').textContent = data;
				})
				.catch(error => console.error('Error:', error));
		}

		document.addEventListener("DOMContentLoaded", updateCartCount);
	</script>
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script th:src="@{/fe/js/jquery-1.11.0.min.js}"></script>
	<script src="https://cdn.jsdelivr.net/npm/swiper@9/swiper-bundle.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
		crossorigin="anonymous"></script>
	<script th:src="@{/fe/js/plugins.js}"></script>
	<script th:src="@{/fe/js/script.js}"></script>
	<!-- Thêm Bootstrap JavaScript và Popper.js -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
		crossorigin="anonymous"></script>
	<!-- Bootstrap JS (Placed before closing body tag) -->
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
	<script>console.log("Script file loaded successfully.");
	</script>
	<!-- script.html -->
	<!-- Đoạn mã script để cập nhật số lượng sản phẩm trong giỏ hàng -->



	<script>
		// Gọi hàm updateCartCount khi trang được tải
		document.addEventListener("DOMContentLoaded", function () {
			console.log("Trang /category đã tải hoàn tất");
			setTimeout(updateCartCount, 200); // Thử thêm một độ trễ nhỏ
		});

		// Hàm updateCartCount để lấy số lượng từ /customer/cart/count và cập nhật vào badge
		function updateCartCount() {
			console.log("Đang chạy hàm updateCartCount");
			fetch('/customer/cart/count')
				.then(response => response.json())
				.then(count => {
					// Cập nhật số lượng sản phẩm trong icon giỏ hàng
					let cartCountElement = document.getElementById('cart-count');
					if (cartCountElement) {
						cartCountElement.textContent = count;
					} else {
						console.warn('Phần tử với ID "cart-count" không tồn tại trên trang này.');
					}
				})
				.catch(error => console.error('Error updating cart count:', error));
		}



		function addToCart(buttonElement) {
			// Lấy productId từ thuộc tính data-product-id của nút
			const productId = buttonElement.getAttribute('data-product-id');
			console.log("Product ID:", productId);

			// Kiểm tra nếu productId không hợp lệ
			if (!productId) {
				console.error("Product ID không hợp lệ.");
				alert("Có lỗi xảy ra. Product ID không hợp lệ.");
				return;
			}

			// Sử dụng ID đã render để tìm ô nhập số lượng
			const quantityInput = document.getElementById(`quantity_${productId}`);
			if (!quantityInput) {
				console.error("Không tìm thấy ô nhập số lượng với ID: quantity_" + productId);
				alert("Có lỗi xảy ra. Không tìm thấy ô nhập số lượng.");
				return;
			}

			// Lấy giá trị số lượng từ ô nhập
			const quantity = parseInt(quantityInput.value);
			if (isNaN(quantity) || quantity < 1) {
				alert("Vui lòng nhập số lượng hợp lệ.");
				return;
			}

			// Gửi yêu cầu thêm sản phẩm vào giỏ hàng
			fetch('/customer/cart/add', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					productId: parseInt(productId, 10),
					quantity: parseInt(quantity, 10)
				})
			})
				.then(response => {
					if (!response.ok) {
						throw new Error('Lỗi mạng không mong muốn: ' + response.status);
					}
					return response.json();
				})
				.then(data => {
					if (data.success) {
						alert("Sản phẩm đã được thêm vào giỏ hàng thành công!");
						updateCartCount(); // cập nhật lại số lượng trong giỏ hàng
					} else {
						alert("Có lỗi xảy ra. Vui lòng thử lại!");
					}
				})
				.catch(error => {
					console.error('Error:', error);
					alert("Có lỗi xảy ra. Vui lòng thử lại!");
				});
		}


		



	</script>